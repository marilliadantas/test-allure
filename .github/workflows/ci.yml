name: Cypress Tests and Allure Report

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

 steps:
  - name: Install dependencies
    run: |
      npm install
      npm install -g allure-commandline
  - name: Run Cypress tests
    run: npm test
  - name: Generate Allure Report
    run: 'npm run allure:report'
  - name: Upload Allure Report
    uses: actions/upload-artifact@v4
    if: always()
    with:
      name: cypress-test-report
      path: allure-report/
  - task: AllureGenerate@1
    inputs:
      resultsDir: $(build.artifactstagingdirectory)\allure-results
      targetDir: allure-report/$(Build.BuildNumber)
  - task: PublishAllureReport@1
    inputs:
      reportDir: allure-report/$(Build.BuildNumber)
  - name: Download Allure Report
    uses: actions/download-artifact@v4
    with:
      name: cypress-test-report